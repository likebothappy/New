<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CodeMarket</title>
    <meta name="robots" content="noindex, nofollow"> <!-- Prevent search engines from indexing admin page -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš€</text></svg>">
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="container">
            <a href="/admin" class="logo">Admin<span>Panel</span></a>
            <!-- Desktop Navigation -->
            <ul class="nav-links">
                <li><a href="/">View Site</a></li>
                <li id="logout-link" class="hidden"><a href="#" onclick="handleLogout()">Logout</a></li>
            </ul>
            <!-- Mobile Navigation (Hamburger Menu) -->
            <button class="hamburger" aria-label="Toggle Menu">
                <span class="line line-1"></span>
                <span class="line line-2"></span>
                <span class="line line-3"></span>
            </button>
        </nav>
        <!-- Mobile Nav -->
        <div class="mobile-nav">
            <ul class="mobile-nav-links">
                <li><a href="/">View Site</a></li>
                <li id="mobile-logout-link" class="hidden"><a href="#" onclick="handleLogout()">Logout</a></li>
            </ul>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Login Form -->
        <section id="login-section" class="container">
            <div style="max-width: 450px; margin: 4rem auto;">
                <div class="card">
                    <h2 class="text-center" style="margin-bottom: 2rem;">Admin Login</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" class="form-control" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" class="form-control" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;" data-original-text="Login">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            <span>Secure Login</span>
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="admin-dashboard" class="container hidden">
            <div class="admin-header">
                <h2>Product Management</h2>
                <button id="add-product-btn" class="btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>Add New Product</span>
                </button>
            </div>

            <!-- Add/Edit Product Modal -->
            <div id="product-modal" class="modal-overlay">
                <div class="card modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title">Add New Product</h3>
                        <button id="close-modal" class="close-btn">Ã—</button>
                    </div>
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-title-input">Product Title</label>
                            <input type="text" id="product-title-input" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="product-description-input">Description</label>
                            <textarea id="product-description-input" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="product-price-input">Price (â‚¹)</label>
                            <input type="number" id="product-price-input" class="form-control" min="0" step="1" required>
                        </div>
                        <div class="form-group">
                            <label for="product-image-input">Image URL</label>
                            <input type="url" id="product-image-input" class="form-control" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="form-group">
                            <label for="product-download-input">Download Link</label>
                            <input type="url" id="product-download-input" class="form-control" placeholder="https://drive.google.com/..." required>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn" data-original-text="Save Product">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                <span>Save Product</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div id="products-loading" class="text-center" style="padding: 2rem;">
                    <div class="spinner"></div>
                </div>
                
                <div id="products-content" class="hidden">
                    <div class="products-table-wrapper">
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Title</th>
                                    <th>Price</th>
                                    <th>Created</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-tbody">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="no-products" class="text-center hidden" style="padding: 2rem;">
                    <p>No products found. <a href="#" onclick="showAddProductModal()" style="color: var(--primary-light);">Add your first product</a></p>
                </div>
            </div>
        </section>
    </main>
    
    <!-- JavaScript & Inline Styles -->
    <script type="module">
        // Add specific admin styles inline to keep HTML clean
        const adminStyles = `
            .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
            .admin-header h2 { font-size: 2rem; }
            .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1010; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
            .modal-overlay.active { opacity: 1; visibility: visible; }
            .modal-content { max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.3s ease; }
            .modal-overlay.active .modal-content { transform: translateY(0); }
            .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
            .close-btn { background: none; border: none; color: var(--text-secondary); font-size: 2rem; cursor: pointer; line-height: 1; }
            .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
            .btn-secondary { background: #374151; }
            .btn-secondary:hover { background: #4B5563; }
            .products-table-wrapper { overflow-x: auto; } /* Makes table scrollable on small screens */
            .products-table { width: 100%; border-collapse: collapse; min-width: 600px; /* Ensures table has a minimum width */ }
            .products-table th, .products-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
            .products-table th { color: var(--text-secondary); font-weight: 600; }
            .products-table .product-admin-image { width: 60px; height: 40px; object-fit: cover; border-radius: 6px; }
            .action-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
            .action-btn.edit:hover { color: #34D399; border-color: #34D399; }
            .action-btn.delete:hover { color: #F87171; border-color: #F87171; }
            .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary-light); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
            @keyframes spin { to { transform: rotate(360deg); } }
        `;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = adminStyles;
        document.head.appendChild(styleSheet);


        import { authService, productService, utils } from './js/firebase-config.js';

        // Hamburger Menu Logic
        const hamburger = document.querySelector('.hamburger');
        const mobileNav = document.querySelector('.mobile-nav');
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            mobileNav.classList.toggle('active');
        });

        // DOM elements
        const loginSection = document.getElementById('login-section');
        const adminDashboard = document.getElementById('admin-dashboard');
        const logoutLink = document.getElementById('logout-link');
        const mobileLogoutLink = document.getElementById('mobile-logout-link');
        const loginForm = document.getElementById('login-form');
        const productModal = document.getElementById('product-modal');
        const productForm = document.getElementById('product-form');
        const productsLoading = document.getElementById('products-loading');
        const productsContent = document.getElementById('products-content');
        const noProducts = document.getElementById('no-products');
        const productsTbody = document.getElementById('products-tbody');
        const modalTitle = document.getElementById('modal-title');

        // Global functions
        window.handleLogout = () => authService.signOut().then(res => res.success && alert('Logged out.'));
        window.showAddProductModal = showAddProductModal;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        
        // Auth state listener
        authService.onAuthStateChanged(user => {
            if (user) {
                loginSection.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                logoutLink.classList.remove('hidden');
                mobileLogoutLink.classList.remove('hidden');
                loadProducts();
            } else {
                loginSection.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
                logoutLink.classList.add('hidden');
                mobileLogoutLink.classList.add('hidden');
            }
        });

        // Login form
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const result = await authService.signIn(email, password);
            if (!result.success) alert(result.error);
        });

        // Product form
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productData = {
                title: document.getElementById('product-title-input').value,
                description: document.getElementById('product-description-input').value,
                price: parseFloat(document.getElementById('product-price-input').value),
                imageUrl: document.getElementById('product-image-input').value,
                downloadUrl: document.getElementById('product-download-input').value
            };
            const productId = document.getElementById('product-id').value;
            const result = productId
                ? await productService.updateProduct(productId, productData)
                : await productService.addProduct(productData);
            
            if (result.success) {
                hideProductModal();
                loadProducts();
            } else {
                alert(result.error);
            }
        });

        // Modal listeners
        document.getElementById('add-product-btn').addEventListener('click', showAddProductModal);
        document.getElementById('close-modal').addEventListener('click', hideProductModal);
        document.getElementById('cancel-btn').addEventListener('click', hideProductModal);
        productModal.addEventListener('click', (e) => e.target === productModal && hideProductModal());

        // Functions
        function showAddProductModal() {
            productForm.reset();
            document.getElementById('product-id').value = '';
            modalTitle.textContent = 'Add New Product';
            productModal.classList.add('active');
        }

        function hideProductModal() {
            productModal.classList.remove('active');
        }

        async function editProduct(productId) {
            const result = await productService.getProduct(productId);
            if (result.success) {
                const p = result.product;
                modalTitle.textContent = 'Edit Product';
                document.getElementById('product-id').value = productId;
                document.getElementById('product-title-input').value = p.title || '';
                document.getElementById('product-description-input').value = p.description || '';
                document.getElementById('product-price-input').value = p.price || '';
                document.getElementById('product-image-input').value = p.imageUrl || '';
                document.getElementById('product-download-input').value = p.downloadUrl || '';
                productModal.classList.add('active');
            } else {
                alert('Error loading product: ' + result.error);
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            const result = await productService.deleteProduct(productId);
            if (result.success) loadProducts();
            else alert(result.error);
        }

        async function loadProducts() {
            productsLoading.classList.remove('hidden');
            productsContent.classList.add('hidden');
            noProducts.classList.add('hidden');

            const result = await productService.getProducts();
            productsLoading.classList.add('hidden');

            if (result.success && result.products.length > 0) {
                productsContent.classList.remove('hidden');
                productsTbody.innerHTML = result.products.map(p => `
                    <tr>
                        <td><img src="${p.imageUrl || ''}" alt="${p.title}" class="product-admin-image"></td>
                        <td>${p.title}</td>
                        <td>â‚¹${p.price.toLocaleString('en-IN')}</td>
                        <td>${p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                        <td style="text-align: right;">
                            <button onclick="editProduct('${p.id}')" class="action-btn edit" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button onclick="deleteProduct('${p.id}')" class="action-btn delete" title="Delete" style="margin-left: 0.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                noProducts.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>